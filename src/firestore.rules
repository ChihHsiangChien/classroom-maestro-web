
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isAuth() { return request.auth != null; }
    function isOwner(doc) { return isAuth() && request.auth.uid == doc.data.ownerId; }
    function isAdmin() { return isAuth() && exists(/databases/$(database)/documents/admins/$(request.auth.uid)); }
    
    // --- USERS & ADMINS ---
    match /users/{userId} {
      allow get, create, update: if (isAuth() && request.auth.uid == userId) || isAdmin();
      allow list, delete: if isAdmin();
    }
    
    match /admins/{adminId} {
      allow get: if isAuth();
      allow list, write: if isAdmin();
    }
    
    // --- CLASSROOMS ---
    match /classrooms/{classroomId} {
      // Students need to read basic classroom info to join
      allow get: if isAuth();
      // Owners can list their own classrooms, admins can list any
      allow list: if isAdmin() || (isAuth() && resource.data.ownerId == request.auth.uid);
      // Owners can create classrooms for themselves
      allow create: if isAuth() && request.resource.data.ownerId == request.auth.uid;
      // Owners and admins can update/delete
      allow update, delete: if isOwner(resource) || isAdmin();
      
      // Sub-collections
      match /submissions/{submissionId} {
        allow read, create: if isAuth();
        allow update, delete: if isAdmin() || isOwner(get(/databases/$(database)/documents/classrooms/$(classroomId)));
      }
      
      match /presence/{studentId} {
        allow read, write: if isAuth();
      }
    }
    
    // --- COURSEWARE ---
    match /courseware/{coursewareId} {
      allow get: if isOwner(resource) || isAdmin();
      allow list: if isAdmin() || (isAuth() && resource.data.ownerId == request.auth.uid);
      allow create: if isAuth() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isOwner(resource) || isAdmin();
    }
    
    // --- AI USAGE LOGS ---
    match /aiUsageLogs/{logId} {
      allow create: if isAuth();
      allow read, list, update, delete: if isAdmin();
    }
  }
}
