rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // =================================
    // Helper Functions
    // =================================
    function isAuthed() {
      return request.auth != null;
    }

    function isOwner(resource) {
      return isAuthed() && request.auth.uid == resource.data.ownerId;
    }
    
    function isAdmin() {
      // To make a user an admin, create a document in the 'admins' collection 
      // with the document ID set to the user's UID.
      return isAuthed() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // =================================
    // Admin & User Profile Rules
    // =================================
    match /admins/{adminId} {
      // Only other admins can see or edit the list of admins.
      allow read, write: if isAdmin();
    }
    
    match /users/{userId} {
      // Authenticated users can create their own user document upon first sign-in.
      allow create: if isAuthed() && request.auth.uid == userId;
      // Users can only read/update their own document.
      allow read, update: if isAuthed() && request.auth.uid == userId;
      // Admins can list all users for the admin panel and delete them.
      allow list, delete: if isAdmin();
    }

    // =================================
    // Main Classroom Rules
    // =================================
    match /classrooms/{classroomId} {
      // Create: An authenticated user can create a classroom if they set themselves as the owner.
      allow create: if isAuthed() && request.resource.data.ownerId == request.auth.uid;
      
      // Read (get a single document): Anyone can get a single classroom's data.
      // This is necessary for students on the /join page to get the classroom name and student list.
      allow get: if true;

      // Read (list multiple documents): 
      // - An admin can list all classrooms.
      // - A regular user can only list the classrooms they own.
      allow list: if isAdmin() || (isAuthed() && request.query.where[0][2] == request.auth.uid);

      // Update/Delete: Only the owner or an admin can update/delete the classroom document itself.
      allow update, delete: if isOwner(resource) || isAdmin();

      // --- SUBCOLLECTION RULES ---

      // Presence subcollection:
      // This collection tracks the online status of students.
      // Since students are not authenticated with Firebase Auth, these rules must be public.
      // This allows the student-facing pages to read the list of online students and
      // update their own presence status.
      match /presence/{studentId} {
        allow read, write: if true;
      }

      // Submissions subcollection:
      // This collection stores student answers to questions.
      match /submissions/{submissionId} {
        // Create: Anyone can create a submission (i.e., answer a question).
        allow create: if true;
        // Read/Write: Only the classroom owner or an admin can read, update, or delete submissions.
        allow read, write: if isOwner(get(/databases/$(database)/documents/classrooms/$(classroomId))) || isAdmin();
      }
    }
  }
}
